var GZ3D=GZ3D||{REVISION:"1"};GZ3D.GZIface=function(a){this.scene=a,this.Init()},GZ3D.GZIface.prototype.Init=function(){this.webSocket=new ROSLIB.Ros({url:"ws://localhost:7681"});var a=new ROSLIB.Topic({ros:this.webSocket,name:"~/scene",messageType:"scene"}),b=function(a){a.grid===!0&&this.scene.CreateGrid();for(var b=0;b<a.light.length;++b){var c=a.light[b],d=this.CreateLightFromMsg(c);this.scene.Add(d)}for(var e=0;e<a.model.length;++e){var f=a.model[e],g=this.CreateModelFromMsg(f);this.scene.Add(g)}};a.subscribe(b.bind(this));var c=new ROSLIB.Topic({ros:this.webSocket,name:"~/pose/info",messageType:"pose"}),d=function(a){var b=this.scene.GetByName(a.name);b&&(b.position=a.position,b.quaternion=a.orientation)};c.subscribe(d.bind(this));var e=new ROSLIB.Topic({ros:this.webSocket,name:"~/request",messageType:"request"}),f=function(a){if("entity_delete"===a.request){var b=this.scene.GetByName(a.data);b&&this.scene.Remove(b)}};e.subscribe(f.bind(this));var g=new ROSLIB.Topic({ros:this.webSocket,name:"~/model/info",messageType:"model"}),h=function(a){var b=this.CreateModelFromMsg(a);this.scene.Add(b)};g.subscribe(h.bind(this));var i=new ROSLIB.Topic({ros:this.webSocket,name:"~/light",messageType:"light"}),j=function(a){var b=this.CreateLightFromMsg(a);this.scene.Add(b)};i.subscribe(j.bind(this))},GZ3D.GZIface.prototype.CreateModelFromMsg=function(a){var b=new THREE.Object3D;b.name=a.name,a.pose&&(b.position=a.pose.position,b.quaternion=a.pose.orientation);for(var c=0;c<a.link.length;++c){var d=a.link[c],e=new THREE.Object3D;e.name=d.name,d.pose&&(e.position=d.pose.position,e.quaternion=d.pose.orientation),b.add(e);for(var f=0;f<d.visual.length;++f){var g=d.visual[f];if(g.geometry){var h=g.geometry,i=new THREE.Object3D;i.name=g.name,g.pose&&(i.position=g.pose.position,i.quaternion=g.pose.orientation),this.scene.CreateGeom(h,g.material,i),e.add(i)}}}return b},GZ3D.GZIface.prototype.CreateLightFromMsg=function(a){var b,c="rgb("+255*a.diffuse.r+","+255*a.diffuse.g+","+255*a.diffuse.b+")";return 1===a.type&&(b=new THREE.PointLight(c),b.distance=a.range),2===a.type?(b=new THREE.SpotLight(c),b.distance=a.range):3===a.type&&(b=new THREE.DirectionalLight(c)),b.intensity=a.attenuation_constant,b.castShadow=a.cast_shadows,a.pose&&(b.position=a.pose.position,b.quaternion=a.pose.orientation),b.name=a.name,b},GZ3D.Scene=function(){this.Init()},GZ3D.Scene.prototype.Init=function(){this.scene=new THREE.Scene,this.renderer=new THREE.WebGLRenderer({antialias:!1}),this.renderer.setClearColor(13421772,1),this.renderer.setSize(window.innerWidth,window.innerHeight);var a=new THREE.AmbientLight(2236962);this.scene.add(a),this.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,1e3),this.camera.position.x=0,this.camera.position.y=-5,this.camera.position.z=5,this.camera.up=new THREE.Vector3(0,0,1),this.camera.lookAt(0,0,0),this.controls=new THREE.TrackballControls(this.camera),this.controls.rotateSpeed=1,this.controls.zoomSpeed=1.2,this.controls.panSpeed=.8,this.controls.noZoom=!1,this.controls.noPan=!1,this.controls.staticMoving=!0,this.controls.dynamicDampingFactor=.3,this.controls.keys=[65,83,68],this.controls.addEventListener("change",this.Render.call(this)),this.iface=new GZ3D.GZIface(this)},GZ3D.Scene.prototype.GetDomElement=function(){return this.renderer.domElement},GZ3D.Scene.prototype.Render=function(){this.renderer.render(this.scene,this.camera),this.controls.update()},GZ3D.Scene.prototype.SetWindowSize=function(a,b){this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b),this.controls.handleResize(),this.Render()},GZ3D.Scene.prototype.Add=function(a){this.scene.add(a)},GZ3D.Scene.prototype.Remove=function(a){this.scene.remove(a)},GZ3D.Scene.prototype.GetByName=function(a){return this.scene.getObjectByName(a)},GZ3D.Scene.prototype.CreateGeom=function(a,b,c){var d;a.box&&(d=this.CreateBox(a.box.size.x,a.box.size.y,a.box.size.z)),a.cylinder&&(d=this.CreateCylinder(a.cylinder.radius,a.cylinder.length)),a.sphere&&(d=this.CreateSphere(a.sphere.radius)),d&&(d.updateMatrix(),c.add(d))},GZ3D.Scene.prototype.CreateGrid=function(){var a=new THREE.GridHelper(10,1);a.rotation.x=.5*Math.PI,this.scene.add(a)},GZ3D.Scene.prototype.CreateSphere=function(a){var b=new THREE.SphereGeometry(a,32,32),c=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),d=new THREE.Mesh(b,c);return d},GZ3D.Scene.prototype.CreateCylinder=function(a,b){var c=new THREE.CylinderGeometry(a,a,b,32,1,!1),d=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),e=new THREE.Mesh(c,d);return e.rotation.x=.5*Math.PI,e},GZ3D.Scene.prototype.CreateBox=function(a,b,c){var d=new THREE.CubeGeometry(a,b,c,1,1,1),e=new THREE.MeshPhongMaterial({color:16777215,shading:THREE.SmoothShading}),f=new THREE.Mesh(d,e);return f};