<!DOCTYPE html>
<html lang="en">
  <head>
    <title>gz3d</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
      body {
        color: #000;
        font-family:Monospace;
        font-size:13px;
        text-align:center;
        font-weight: bold;

        background-color: #fff;
        margin: 0px;
        overflow: hidden;
      }

      #info {
	      color:#000;
	      position: absolute;
	      top: 0px; width: 100%;
	      padding: 5px;

      }

      a {
        color: red;
      }
    </style>
  </head>

  <body>
    <div id="container"></div>
    <script src="js/three.min.js"></script>
    <script src="js/controls/TrackballControls.js"></script>
    <script src="js/Detector.js"></script>
    <script src="js/libs/stats.min.js"></script>
    <script src="js/eventemitter2.js"></script>
<!--    <script src="js/gzwebsocket.js"></script> -->
    <script src="js/roslib.js"></script>
    <script>

      if (!Detector.webgl)
        Detector.addGetWebGLMessage();

      var container, stats;
      var camera, controls, scene, renderer;
      var cross;
      var visuals = {};
      var webSocket;

      connectToWebServer();
      init();
      animate();


      function init()
      {
        camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 1000 );
        camera.position.z = 5;
        camera.position.y = 5;
        camera.lookAt(0, 0, 0);

        controls = new THREE.TrackballControls( camera );

        controls.rotateSpeed = 1.0;
        controls.zoomSpeed = 1.2;
        controls.panSpeed = 0.8;

        controls.noZoom = false;
        controls.noPan = false;

        controls.staticMoving = true;
        controls.dynamicDampingFactor = 0.3;

        controls.keys = [ 65, 83, 68 ];

        controls.addEventListener( 'change', render );

        // world

        scene = new THREE.Scene();
        // scene.fog = new THREE.FogExp2( 0xcccccc, 0.002 );

        var geometry = new THREE.CylinderGeometry( 0, 1, 3, 4, 1 );
        var material =  new THREE.MeshLambertMaterial( { color:0xffffff, shading: THREE.FlatShading } );
        var mesh = new THREE.Mesh( geometry, material );
        mesh.position.x = 0;
        mesh.position.y = 0;
        mesh.position.z = 0;
        mesh.updateMatrix();
        mesh.matrixAutoUpdate = false;
        scene.add( mesh );

        visuals['ian'] = mesh;

        // lights
        light = new THREE.DirectionalLight( 0xffffff );
        light.position.set( 1, 1, 1 );
        scene.add( light );

        light = new THREE.AmbientLight( 0x222222 );
        scene.add( light );

        // grid
        scene.add( new THREE.GridHelper( 10, 1 ) );

        // renderer
        renderer = new THREE.WebGLRenderer( { antialias: false } );
        renderer.setClearColor( 0xcccccc, 1 );
        renderer.setSize( window.innerWidth, window.innerHeight );

        container = document.getElementById( 'container' );
        container.appendChild( renderer.domElement );

        stats = new Stats();
        stats.domElement.style.position = 'absolute';
        stats.domElement.style.top = '0px';
        stats.domElement.style.zIndex = 100;
        container.appendChild( stats.domElement );

        window.addEventListener( 'resize', onWindowResize, false );



        var updateTopic = new ROSLIB.Topic({
          ros : webSocket,
          name : '/topic',
          messageType : '/msg',
        });
          //console.log("new topic");

        processUpdate = function(message)
        {
          console.log("process update " + message.posX);

          visuals['ian'].position.x = message.posX;
          visuals['ian'].updateMatrix();
//          setInterval(onReceiveMessage,0.1);

        }
        updateTopic.subscribe(processUpdate.bind());


        var updateTopic2 = new ROSLIB.Topic({
          ros : webSocket,
          name : '/topic2',
          messageType : '/msg',
        });
          //console.log("new topic");

        processUpdate2 = function(message)
        {
          console.log("process update2 " + message.posY);

          visuals['ian'].position.y = message.posY;
          visuals['ian'].updateMatrix();
//          setInterval(onReceiveMessage,0.1);

        }
  //      updateTopic2.subscribe(processUpdate2.bind());

        var updateTopic3 = new ROSLIB.Topic({
          ros : webSocket,
          name : '/topic3',
          messageType : '/msg',
        });
          //console.log("new topic");

        processUpdate3 = function(message)
        {
          console.log("process update3 " + message.posZ);

          visuals['ian'].position.z = message.posZ;
          visuals['ian'].updateMatrix();
//          setInterval(onReceiveMessage,0.1);

        }
     //   updateTopic3.subscribe(processUpdate3.bind());

      }

      function onWindowResize()
      {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );
        controls.handleResize();
        render();
      }

      function animate()
      {
        requestAnimationFrame( animate );
        render();
        controls.update();
      }

      function render()
      {
        renderer.render( scene, camera );
        stats.update();
      }

      function connectToWebServer()
      {
        webSocket = new ROSLIB.Ros({
          url : 'ws://localhost:7681'
        });


      }
    </script>

  </body>
</html>
